<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electricity consumption calc</title>
    <link rel="stylesheet" href="./main.css">
</head>
<body>
    <div class="head">
        <div class="indent">
            <h2>Electricity consumption calculator</h2>
            <p>Prices come from Nord Pool Spot (NPS), stock market prices only.</p>
        </div>
        
    </div>
    <div class="buttons">
        <input type="file" accept=".csv" placeholder="CSV file exported from Elektrilevi" onchange="showFile(this)" required />
        <input type="date" required id="date_start" />
        <input type="date" required id="date_end" />
        <input type="button" value="Calculate consumption" onclick="calculate()" />
        
    </div>
    </div>
    <div class="body">
        <h3>Selected data range NPS stock prices graph</h3>
        <div style="display: block;">
            <canvas id="npsPrices" width="500" height="250"></canvas>
        </div>
        <h3>Current month electricity consumption graph</h3>
        <div>

        </div>
    </div>
    
    <script>
        // Convert user supplied .CSV file to array for later use and generate user electricity consumption table
        function showFile(input) {
            let file = input.files[0];

            alert(`File name: ${file.name}`);
        }

        // Get user set date range from inputs
        function dateRange () {
            const date_start = document.getElementById("date_start");
            const date_end = document.getElementById("date_end");
            const date_settings = [];
            date_settings.push(date_start.value, date_end.value);

            return date_settings;
        }

        // Use user set date range for retrieving Nord Pool Spot electricity prices by Elering API means and generate prices table
        function getDataFromElering(date_setting) {
            let data = null;
            console.log("Getting data from elering");
            const url = `https://dashboard.elering.ee/api/nps/price?start=${date_setting[0]}T00%3A00%3A00.000Z&end=${date_setting[1]}T00%3A00%3A00.000Z`;
            fetch(url)
                .then((response) => response.json())
                .then((res) => {
                    // Drawing graph to canvas
                    let canvas = document.getElementById("npsPrices");
                    let ctx = canvas.getContext("2d");
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = "#CCC";
                    // Vertical line
                    ctx.fillRect(0, 0, 500, 250);
                    ctx.beginPath();
                    ctx.moveTo(60, 25);
                    ctx.lineTo(58, 30);
                    ctx.moveTo(60, 25);
                    ctx.lineTo(62, 30);
                    ctx.moveTo(60, 25);
                    ctx.lineTo(60, 200);
                    // Horizontal line
                    ctx.lineTo(475, 200);
                    ctx.lineTo(470, 202);
                    ctx.moveTo(475, 200);
                    ctx.lineTo(470, 198);
                    ctx.font = "8px arial";
                    ctx.fillStyle = "#000";
                    ctx.fillText("0", 50, 210)
                    ctx.fillText("NPS price", 10, 40);
                    ctx.fillText("Hours", 425, 235);
                    // Draws small strokes to horisontal line
                    let pointWidth = 385/res.data.ee.length;
                    let dataPointCount = res.data.ee.length;
                    let x = 60 + pointWidth;
                    let x2 = 57 + pointWidth;
                    ctx.moveTo(x, 200);
                    for(var i = 0; i < dataPointCount; i++) {
                        let width = x + (i * pointWidth);
                        let width2 = x2 + (i * pointWidth);
                        ctx.moveTo(width, 195);
                        ctx.lineTo(width, 205);
                    }
                    ctx.moveTo(x, 205);
                    // Draws diagonal lines to small vertical lines
                    for(var i = 0; i < dataPointCount; i++) {
                        let width = x + (i * pointWidth);
                        let width2 = x2 + (i * pointWidth) - 1;
                        ctx.moveTo(width, 205);
                        ctx.lineTo(width2, 212);
                        ctx.fillText(i+1, width2-5, 222);
                    }

                    const maxPrice = Math.max(res.data.ee);
                    console.log(maxPrice);

                    ctx.stroke();
                })
                .catch(err => {throw err});
        }

        // Calculate electricity consumption for user based on Nord Pool Spot prices and user consumption and generate table from calculations
        function calculate() {
            const date_setting = dateRange();
            getDataFromElering(date_setting);
        }
    </script>
</body>
</html>